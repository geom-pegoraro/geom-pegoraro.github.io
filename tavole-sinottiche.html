<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Geom. Pegoraro Alex — Tavole Sinottiche in 24h</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,300;0,400;0,500;0,600;1,300&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:       #0f1117;
    --bg2:      #161b26;
    --bg3:      #1c2233;
    --border:   rgba(255,255,255,0.07);
    --border2:  rgba(255,255,255,0.13);
    --text:     #dde4f0;
    --muted:    #6e7d96;
    --dim:      #3d4a5e;
    --red:      #c0392b;
    --red-s:    rgba(192,57,43,0.10);
    --red-b:    rgba(192,57,43,0.30);
    --yellow:   #c9970a;
    --yellow-s: rgba(201,151,10,0.09);
    --yellow-b: rgba(201,151,10,0.28);
    --green:    #1e8449;
    --font: 'Inter', sans-serif;
    --mono: 'DM Mono', monospace;
    --r: 3px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { scroll-behavior: smooth; }
  body { background: var(--bg); color: var(--text); font-family: var(--font); font-weight: 300; font-size: 15px; line-height: 1.65; -webkit-font-smoothing: antialiased; overflow-x: hidden; }
  #bg-canvas { position: fixed; inset: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
  .wrap { max-width: 840px; margin: 0 auto; padding: 0 22px; position: relative; z-index: 1; }

  h1 { font-size: clamp(2rem, 4.5vw, 3rem); font-weight: 600; line-height: 1.12; letter-spacing: -0.03em; color: #fff; }
  h2 { font-size: clamp(1.2rem, 2.2vw, 1.55rem); font-weight: 600; letter-spacing: -0.02em; color: #fff; margin-bottom: 24px; }

  header { position: relative; z-index: 1; border-bottom: none; padding: 17px 0; }
  .hdr { max-width: 840px; margin: 0 auto; padding: 0 22px; display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; }
  .hdr-name { font-size: 0.9rem; font-weight: 600; color: #fff; letter-spacing: -0.01em; }
  .hdr-sub { font-family: var(--mono); font-size: 0.62rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; margin-top: 2px; }
  .hdr-back { font-family: var(--mono); font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red); border: 1px solid var(--red-b); background: var(--red-s); padding: 5px 13px; border-radius: 2px; text-decoration: none; transition: background 0.15s; }
  .hdr-back:hover { background: rgba(192,57,43,0.2); }

  .hero { padding: 80px 0 64px; border-bottom: none; position: relative; z-index: 1; }
  .hero-eye { font-family: var(--mono); font-size: 0.67rem; letter-spacing: 0.14em; text-transform: uppercase; color: var(--yellow); margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
  .hero-eye::before { content: ''; display: block; width: 26px; height: 1px; background: var(--yellow); flex-shrink: 0; }
  .hero h1 { margin-bottom: 20px; }
  .hero h1 .cr { color: var(--red); }
  .hero h1 .cy { color: var(--yellow); }
  .hero-desc { font-size: 0.97rem; color: var(--muted); max-width: 500px; line-height: 1.8; margin-bottom: 36px; }
  .btn { display: inline-block; background: var(--red); color: #fff; text-decoration: none; padding: 13px 28px; font-size: 0.82rem; font-weight: 500; letter-spacing: 0.07em; text-transform: uppercase; border-radius: var(--r); border: 1px solid var(--red); transition: background 0.16s, color 0.16s; cursor: pointer; font-family: var(--font); }
  .btn:hover { background: transparent; color: var(--red); }

  .kpis { margin-top: 52px; padding-top: 36px; border-top: none; display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
  .kpi { border-left: 1px solid var(--border); padding-left: 18px; }
  .kpi-v { font-size: 2rem; font-weight: 600; color: #fff; letter-spacing: -0.03em; line-height: 1; margin-bottom: 4px; }
  .kpi-l { font-family: var(--mono); font-size: 0.62rem; color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase; }

  .sec { padding: 52px 0; border-bottom: none; position: relative; z-index: 1; }

  .box-red { background: var(--red-s); border: 1px solid var(--red-b); border-left: 3px solid var(--red); border-radius: var(--r); padding: 22px 26px; margin-bottom: 20px; }
  .box-acc .bx-tag { font-family: var(--font); font-size: 0.72rem; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 10px; }
  .box-red p { font-size: 0.88rem; color: var(--text); line-height: 1.82; }
  .box-yellow { background: var(--yellow-s); border: 1px solid var(--yellow-b); border-left: 3px solid var(--yellow); border-radius: var(--r); padding: 14px 20px; font-size: 0.85rem; color: var(--text); line-height: 1.75; margin: 18px 0; }

  .req-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 18px; }
  .req-card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); padding: 18px 20px; }
  .req-card .rc-tag { font-family: var(--font); font-size: 0.72rem; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 7px; display: block; }
  .req-card p { font-weight: 400; font-size: 0.85rem; color: var(--muted); line-height: 1.7; }
  .req-card strong { color: var(--text); font-weight: 500; }

  .pricing-table { width: 100%; border-collapse: collapse; border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; margin-bottom: 16px; }
  .pricing-table thead tr { background: var(--bg3); }
  .pricing-table th { font-family: var(--mono); font-size: 0.6rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); padding: 11px 17px; text-align: left; border-bottom: 1px solid var(--border); }
  .pricing-table td { font-weight: 400; padding: 14px 17px; font-size: 0.87rem; color: var(--muted); border-bottom: 1px solid var(--border); vertical-align: middle; }
  .pricing-table tr:last-child td { border-bottom: none; }
  .pricing-table tbody tr:hover td { background: var(--bg2); }
  .td-name { color: var(--text) !important; font-weight: 500; }
  .td-price { font-size: 1.25rem !important; font-weight: 600; color: #fff !important; letter-spacing: -0.02em; }
  .pricing-note { font-family: var(--mono); font-size: 0.68rem; color: var(--muted); line-height: 2; }

  /* Calcolatore */
  .pkg-sel-card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); padding: 20px 22px; cursor: pointer; transition: border-color 0.15s, background 0.15s; position: relative; }
  .pkg-sel-card:hover { border-color: var(--border2); }
  .pkg-sel-card.selected { border-color: var(--red-b); background: var(--red-s); border-left: 3px solid var(--red); }
  .pkg-sel-tag { font-family: var(--font); font-size: 0.72rem; font-weight: 600; color: var(--dim); letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 6px; }
  .pkg-sel-card.selected .pkg-sel-tag { font-family: var(--font); font-size: 0.72rem; font-weight: 600; color: var(--dim); letter-spacing: 0.04em; text-transform: uppercase; margin-bottom: 6px; }
  .pkg-sel-title { font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 4px; }
  .pkg-sel-desc { font-size: 0.82rem; color: var(--muted); line-height: 1.6; }
  .pkg-sel-price { font-size: 1.4rem; font-weight: 600; color: var(--red); letter-spacing: -0.02em; white-space: nowrap; flex-shrink: 0; }
  .pkg-sel-check { display: none; margin-top: 10px; font-family: var(--mono); font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--red); }
  .pkg-sel-card.selected .pkg-sel-check { display: block; }
  .preventivo-box { background: var(--bg3); border: 1px solid var(--red-b); border-radius: var(--r); overflow: hidden; margin-bottom: 20px; }
  .prev-header { background: rgba(192,57,43,0.15); border-bottom: 1px solid var(--red-b); padding: 12px 20px; font-family: var(--font); font-size: 0.75rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; color: var(--red); }
  .prev-body { padding: 18px 20px 14px; }
  .prev-righe { margin-bottom: 14px; }
  .prev-riga { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 0.84rem; color: var(--muted); }
  .prev-riga:last-child { border-bottom: none; }
  .prev-riga span:last-child { font-family: var(--mono); font-size: 0.82rem; color: var(--text); }
  .prev-totale-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0 4px; border-top: 1px solid var(--border2); margin-top: 4px; }
  .prev-totale-label { font-family: var(--mono); font-size: 0.62rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--dim); }
  .prev-totale-val { font-size: 1.8rem; font-weight: 600; color: #fff; letter-spacing: -0.03em; }
  .prev-note { background: rgba(0,0,0,0.2); border-top: 1px solid var(--border); padding: 9px 20px; font-family: var(--mono); font-size: 0.63rem; color: var(--dim); line-height: 1.7; }
  .calc-cta-btn { margin-top: 16px; background: var(--red); color: #fff; border: 1px solid var(--red); border-radius: var(--r); padding: 12px 28px; font-family: var(--font); font-size: 0.82rem; font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: background 0.15s, color 0.15s, opacity 0.15s; display: none; }
  .calc-cta-btn:hover { background: transparent; color: var(--red); }
  .calc-cta-btn.confermato { background: var(--green); border-color: var(--green); color: #fff; }
  .calc-cta-btn.confermato:hover { background: var(--green); opacity: 0.85; }
  .prev-warning { display: none; margin-top: 10px; padding: 10px 14px; background: rgba(192,57,43,0.10); border: 1px solid rgba(192,57,43,0.35); border-left: 3px solid #c0392b; border-radius: var(--r); font-family: var(--mono); font-size: 0.72rem; color: #e07060; line-height: 1.6; }

  .wf { display: grid; grid-template-columns: repeat(4, 1fr); border: 1px solid var(--border); border-radius: var(--r); overflow: hidden; margin-bottom: 8px; }
  .wf-s { background: var(--bg2); padding: 20px 16px; border-right: 1px solid var(--border); }
  .wf-s:last-child { border-right: none; }
  .wf-n { font-family: var(--font); font-size: 0.68rem; font-weight: 600; color: var(--muted); letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 7px; display: block; }
  .wf-t { font-size: 0.83rem; font-weight: 500; color: #fff; margin-bottom: 6px; }
  .wf-d { font-size: 0.76rem; color: var(--muted); line-height: 1.6; }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .fg { display: flex; flex-direction: column; gap: 7px; }
  .fg.full { grid-column: 1 / -1; }
  .fg label { font-family: var(--mono); font-size: 0.61rem; letter-spacing: 0.1em; text-transform: uppercase; color: var(--dim); }
  .fg label .req { color: var(--red); }
  .fg input[type="text"], .fg input[type="email"], .fg input[type="tel"], .fg textarea, .fg select { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); color: var(--text); padding: 11px 14px; font-family: var(--font); font-size: 0.9rem; font-weight: 400; outline: none; width: 100%; transition: border-color 0.14s; }
  .fg select { cursor: pointer; }
  .fg select option { background: var(--bg2); }
  .fg input:focus, .fg textarea:focus, .fg select:focus { border-color: var(--border2); }
  .fg textarea { resize: vertical; min-height: 88px; }
  .fg input[type="file"] { background: var(--bg2); border: 1px dashed var(--border); border-radius: var(--r); color: var(--muted); padding: 22px 16px; font-family: var(--mono); font-size: 0.72rem; width: 100%; cursor: pointer; transition: border-color 0.14s; }
  .fg input[type="file"]::file-selector-button { background: var(--bg3); border: 1px solid var(--border2); border-radius: var(--r); color: var(--text); padding: 7px 14px; font-family: var(--mono); font-size: 0.68rem; letter-spacing: 0.08em; text-transform: uppercase; cursor: pointer; margin-right: 14px; }
  .zip-box { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--r); padding: 16px 20px; margin-top: 10px; }
  .zip-box p { font-family: var(--mono); font-size: 0.7rem; color: var(--muted); line-height: 1.95; }
  .zip-box .zy { color: var(--yellow); }
  .zip-box .zt { color: var(--text); font-weight: 500; }

  .chk-row { display: flex; align-items: flex-start; gap: 12px; background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); padding: 15px 18px; margin-top: 12px; cursor: pointer; transition: border-color 0.14s; }
  .chk-row:hover { border-color: var(--border2); }
  .chk-row input[type="checkbox"] { appearance: none; -webkit-appearance: none; width: 17px; height: 17px; min-width: 17px; border: 1px solid var(--dim); background: transparent; border-radius: 2px; cursor: pointer; margin-top: 2px; position: relative; transition: background 0.14s, border-color 0.14s; }
  .chk-row input[type="checkbox"]:checked { background: var(--red); border-color: var(--red); }
  .chk-row input[type="checkbox"]:checked::after { content: '✓'; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #fff; font-size: 10px; font-weight: 700; line-height: 1; }
  .chk-row label { font-size: 0.86rem; color: var(--muted); cursor: pointer; line-height: 1.65; }
  .chk-row strong { color: var(--text); font-weight: 500; }

  .submit-area { margin-top: 24px; }
  .submit-row { display: flex; align-items: center; gap: 20px; margin-top: 18px; flex-wrap: wrap; }
  button[type="submit"] { background: var(--red); color: #fff; border: 1px solid var(--red); border-radius: var(--r); padding: 14px 32px; font-family: var(--font); font-size: 0.85rem; font-weight: 500; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: background 0.15s, color 0.15s; }
  button[type="submit"]:hover { background: transparent; color: var(--red); }
  button[type="submit"]:disabled { opacity: 0.45; cursor: not-allowed; }
  .submit-hint { font-family: var(--mono); font-size: 0.67rem; color: var(--muted); line-height: 1.9; }

  footer { position: relative; z-index: 1; border-top: none; padding: 28px 0; }
  .ft { max-width: 840px; margin: 0 auto; padding: 0 22px; display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: center; }
  .ft-info p { font-family: var(--mono); font-size: 0.75rem; color: var(--muted); line-height: 2.1; }
  .ft-info a { color: var(--text); text-decoration: none; }
  .ft-name { font-size: 0.95rem; font-weight: 600; color: #fff; margin-bottom: 6px; }
  .ft-right { font-family: var(--mono); font-size: 0.72rem; color: var(--muted); text-align: right; line-height: 2; }
  .ft-legal { max-width: 840px; margin: 14px auto 0; padding: 14px 22px 0; border-top: none; font-family: var(--mono); font-size: 0.68rem; color: var(--muted); line-height: 1.85; }

  #form-overlay { display:none; position:fixed; inset:0; z-index:999; background:rgba(10,12,18,0.96); backdrop-filter:blur(6px); align-items:center; justify-content:center; flex-direction:column; gap:28px; padding:32px; text-align:center; }
  #form-overlay.active { display:flex; }
  .ov-seal { font-family:var(--mono); font-size:0.6rem; letter-spacing:0.22em; text-transform:uppercase; color:var(--muted); border:1px solid var(--border2); padding:6px 18px; border-radius:2px; }
  .ov-spinner { width:44px; height:44px; border:2px solid var(--border2); border-top-color:var(--red); border-radius:50%; animation:spin 1.1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .ov-title { font-size:clamp(1rem,2.5vw,1.35rem); font-weight:500; color:#fff; letter-spacing:-0.02em; max-width:520px; line-height:1.5; }
  .ov-subtitle { font-family:var(--mono); font-size:0.72rem; color:var(--muted); max-width:440px; line-height:1.9; }
  .ov-progress-wrap { width:280px; height:2px; background:var(--border2); border-radius:2px; overflow:hidden; }
  .ov-progress-bar { height:100%; background:var(--red); width:0%; transition:width 0.5s ease; border-radius:2px; }
  .ov-check { width:54px; height:54px; border:2px solid var(--green); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:var(--green); }
  .ov-date { font-family:var(--mono); font-size:0.6rem; letter-spacing:0.15em; color:var(--muted); border-top:1px solid var(--border); padding-top:18px; max-width:400px; line-height:1.9; }
  .ov-error-icon { width:54px; height:54px; border:2px solid var(--red); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; color:var(--red); }
  .ov-btn-back { background:transparent; color:var(--red); border:1px solid var(--red-b); border-radius:var(--r); padding:11px 28px; font-family:var(--mono); font-size:0.72rem; letter-spacing:0.1em; text-transform:uppercase; cursor:pointer; transition:background 0.16s; margin-top:8px; }
  .ov-btn-back:hover { background:var(--red-s); }
  .zip-error { display:none; margin-top:8px; padding:10px 14px; background:rgba(192,57,43,0.10); border:1px solid rgba(192,57,43,0.35); border-left:3px solid #c0392b; border-radius:var(--r); font-family:var(--mono); font-size:0.72rem; color:#e07060; line-height:1.6; }

  @media (max-width: 680px) {
    .req-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .fg.full { grid-column: 1; }
    .ft { grid-template-columns: 1fr; }
    .ft-right { text-align: left; }
    .kpis { grid-template-columns: 1fr 1fr; }
    .wf { grid-template-columns: 1fr 1fr; }
    .wf-s:nth-child(even) { border-right: none; }
    .pricing-table th:nth-child(3), .pricing-table td:nth-child(3) { display: none; }
  }
</style>
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">
</head>
<body>

<canvas id="bg-canvas"></canvas>

<header>
  <div class="hdr">
    <div>
      <div class="hdr-name">Geom. Pegoraro Alex</div>
      <div class="hdr-sub">Servizi Tecnici Grafici</div>
    </div>
    <a href="index.html" class="hdr-back">← Tutti i Servizi</a>
  </div>
</header>

<!-- HERO -->
<div class="hero">
  <div class="wrap">
    <div class="hero-eye">Servizio 01</div>
    <h1>Tavole <span class="cr">Sinot</span><span class="cy">tiche</span><br>in 24h</h1>
    <p class="hero-desc">Elaborazione grafica di tavole sinottiche Stato di Fatto / Progetto a partire dai tuoi file DWG. Supporto tecnico per pratiche edilizie e documentazione di progetto. Consegna garantita in 24h lavorative dal pagamento.</p>
    <a href="#commissione" class="btn">Invia Commissione →</a>
    <div class="kpis">
      <div class="kpi"><div class="kpi-v">24h</div><div class="kpi-l">Consegna dal saldo</div></div>
      <div class="kpi"><div class="kpi-v">DWG+PDF</div><div class="kpi-l">Formati consegnati</div></div>
      <div class="kpi"><div class="kpi-v">da 55€</div><div class="kpi-l">Tariffa base</div></div>
    </div>
  </div>
</div>

<!-- §01 DESCRIZIONE SERVIZIO -->
<div class="sec">
  <div class="wrap">
    <h2>Cos'è una Tavola Sinottica?</h2>

    <p style="font-size:0.92rem; color:var(--muted); line-height:1.85; margin-bottom:22px;">Una tavola sinottica sovrappone graficamente lo <strong style="color:var(--text)">Stato di Fatto</strong> e il <strong style="color:var(--text)">Progetto</strong>, evidenziando in colori differenziati le demolizioni (da eliminare) e le nuove realizzazioni (da aggiungere). È un elaborato richiesto nelle pratiche SCIA, DIA, permessi di costruire e simili.</p>
    <div class="req-grid">
      <div class="req-card">
        <span class="rc-tag">Input del cliente</span>
        <p>Due file <strong>DWG perfettamente sovrapponibili</strong>: pianta Stato di Fatto e pianta Progetto, con la stessa scala e origine geometrica. Più un file <strong>.TXT</strong> con le specifiche dei layer.</p>
      </div>
      <div class="req-card">
        <span class="rc-tag">Output consegnato</span>
        <p>Tavola sinottica in <strong>DWG</strong> con layer differenziati + <strong>PDF alta risoluzione</strong> (300+ dpi) stampabile nelle scale concordate (1:50, 1:100, ecc.).</p>
      </div>
      <div class="req-card">
        <span class="rc-tag">Colori standard</span>
        <p>Default: <strong style="color:#FFD700">Giallo</strong> = demolizioni (da eliminare) · <strong style="color:#e07060">Rosso</strong> = nuove realizzazioni. Personalizzabile nel file .TXT allegato.</p>
      </div>
      <div class="req-card">
        <span class="rc-tag">Rigetto automatico</span>
        <p>File <strong>non sovrapponibili</strong> vengono rigettati senza addebito. Il cliente riceve notifica via mail e può reinviare i file corretti entro 5 gg. lavorativi.</p>
      </div>
    </div>
  </div>
</div>

<!-- §02 PACCHETTI E TARIFFE -->
<div class="sec">
  <div class="wrap">
    <h2>Pacchetti e Tariffe</h2>
    <p style="font-size:0.88rem; color:var(--muted); margin-bottom:20px; line-height:1.8;">Tre opzioni chiare. I prezzi sono comprensivi di imposta di bollo (€2,00) e contributo CIPAG (5%), esattamente come indicato in fattura.</p>
    <table class="pricing-table">
      <thead>
        <tr><th>Servizio</th><th>Descrizione</th><th>Prezzo</th><th>Consegna</th></tr>
      </thead>
      <tbody>
        <tr>
          <td class="td-name">Tavola Standard</td>
          <td>File DWG conformi, fino a 2 layer differenziati (Ante/Post). Ideale per pratiche SCIA standard su singolo piano.</td>
          <td><span class="td-price">55€</span></td>
          <td>24h dal saldo</td>
        </tr>
        <tr>
          <td class="td-name">Tavola Complessa</td>
          <td>Più di 2 layer differenziati, piante multi-piano o elaborazioni particolari che richiedono gestione avanzata dei layer.</td>
          <td><span class="td-price">75€</span></td>
          <td>24h dal saldo</td>
        </tr>
        <tr>
          <td class="td-name">Revisione Post-Consegna</td>
          <td>Modifica della tavola già consegnata per variazione del committente (es. cambio colori, aggiunta elementi, correzione layer).</td>
          <td><span class="td-price">30€</span></td>
          <td>12h dal saldo</td>
        </tr>
      </tbody>
    </table>
    <p class="pricing-note">
      Prezzi non soggetti a IVA (regime forfettario) · Contributo CIPAG 5% + imposta di bollo €2,00 inclusi in fattura<br>
      Pagamento: Bonifico bancario · PayPal · Fattura entro 48h dalla ricezione commessa
    </p>
  </div>
</div>

<!-- §03 CALCOLA IL PREVENTIVO -->
<div class="sec" id="calcolatore">
  <div class="wrap">
    <h2>Calcola il tuo Preventivo</h2>
    <p style="font-size:0.88rem; color:var(--muted); margin-bottom:24px; line-height:1.8;">Seleziona il servizio desiderato e ottieni subito il preventivo completo, già comprensivo di bollo e CIPAG. Il bottone qui sotto compila automaticamente il form con i tuoi dati.</p>

    <div style="display:grid; gap:12px; margin-bottom:24px;" id="pkg-cards">
      <div class="pkg-sel-card" id="card-std" tabindex="0">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
          <div>
            <div class="pkg-sel-tag">Servizio Standard</div>
            <div class="pkg-sel-title">Tavola Sinottica Standard</div>
            <div class="pkg-sel-desc">DWG conformi · fino a 2 layer differenziati · Consegna 24h dal saldo</div>
          </div>
          <div class="pkg-sel-price">55 €</div>
        </div>
        <div class="pkg-sel-check">✓ Selezionato</div>
      </div>
      <div class="pkg-sel-card" id="card-cplx" tabindex="0">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
          <div>
            <div class="pkg-sel-tag">Servizio Complesso</div>
            <div class="pkg-sel-title">Tavola Sinottica Complessa</div>
            <div class="pkg-sel-desc">Più di 2 layer differenziati o piante multi-piano · Consegna 24h dal saldo</div>
          </div>
          <div class="pkg-sel-price">75 €</div>
        </div>
        <div class="pkg-sel-check">✓ Selezionato</div>
      </div>
      <div class="pkg-sel-card" id="card-rev" tabindex="0">
        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px;">
          <div>
            <div class="pkg-sel-tag">Revisione</div>
            <div class="pkg-sel-title">Revisione Post-Consegna</div>
            <div class="pkg-sel-desc">Modifica per variazione del committente · Consegna 12h dal saldo</div>
          </div>
          <div class="pkg-sel-price">30 €</div>
        </div>
        <div class="pkg-sel-check">✓ Selezionato</div>
      </div>
    </div>

    <div class="preventivo-box" id="preventivo-box" style="display:none;">
      <div class="prev-header">Preventivo Indicativo</div>
      <div class="prev-body">
        <div class="prev-righe" id="prev-righe"></div>
        <div class="prev-totale-row">
          <span class="prev-totale-label">Totale da Corrispondere</span>
          <span class="prev-totale-val" id="prev-totale">—</span>
        </div>
      </div>
      <div class="prev-note">Imposta di bollo €2,00 + contributo CIPAG 5% già inclusi · Pagamento: Bonifico bancario · PayPal</div>
    </div>
    <button class="calc-cta-btn" id="calc-cta-btn" type="button">Aggiungi a Commessa →</button>
    <div class="prev-warning" id="prev-warning">⚠ Devi prima calcolare e aggiungere il preventivo alla commessa prima di poter inviare.</div>

    <input type="hidden" id="pacchetto-selezionato" name="pacchetto_selezionato" value="">
    <input type="hidden" id="preventivo-totale-hidden" name="preventivo_totale" value="">
    <input type="hidden" id="preventivo-dettaglio-hidden" name="preventivo_dettaglio" value="">

    <p class="pricing-note" style="margin-top:18px;">
      ⓘ Il preventivo è indicativo. La parcella definitiva verrà inviata via mail entro 48h dalla ricezione della commissione.
    </p>
  </div>
</div>

<!-- §04 COSA FORNIRE -->
<div class="sec">
  <div class="wrap">
    <h2>Come Funziona</h2>
    <p style="font-size:0.88rem; color:var(--muted); margin-bottom:20px; line-height:1.8;">Il processo è semplice e completamente digitale. Dalla commissione alla consegna in 4 passi.</p>
    <div class="wf">
      <div class="wf-s">
        <span class="wf-n">STEP 01</span>
        <div class="wf-t">Invio Commissione</div>
        <div class="wf-d">Compila il modulo qui sotto, seleziona il pacchetto e allega il file ZIP con DWG + file .TXT specifiche.</div>
      </div>
      <div class="wf-s">
        <span class="wf-n">STEP 02</span>
        <div class="wf-t">Parcella via Mail</div>
        <div class="wf-d">Entro 48h lavorative ricevi la parcella con l'importo definitivo e le coordinate di pagamento.</div>
      </div>
      <div class="wf-s">
        <span class="wf-n">STEP 03</span>
        <div class="wf-t">Pagamento</div>
        <div class="wf-d">Il timer di 24h parte dalla conferma del pagamento ricevuto (bonifico o PayPal).</div>
      </div>
      <div class="wf-s">
        <span class="wf-n">STEP 04</span>
        <div class="wf-t">Consegna File</div>
        <div class="wf-d">Ricevi le tavole elaborate in DWG e PDF entro 24h lavorative, direttamente via email.</div>
      </div>
    </div>
  </div>
</div>

<!-- §05 COME FUNZIONA -->
<div class="sec">
  <div class="wrap">
    <h2>Cosa Fornire</h2>
    <p style="font-size:0.88rem; color:var(--muted); margin-bottom:20px; line-height:1.8;">Tutti i file vanno compressi in un unico archivio <strong style="color:var(--text)">.ZIP</strong> e allegati al modulo qui sotto. La qualità e completezza dei file influisce direttamente sulla qualità del risultato.</p>
    <div class="req-grid">
      <div class="req-card">
        <span class="rc-tag">File Obbligatori</span>
        <p>
          <strong>stato_di_fatto.dwg</strong> — Pianta Stato di Fatto<br>
          <strong>progetto.dwg</strong> — Pianta Progetto (deve essere sovrapponibile al precedente: stessa scala, stessa origine geometrica)<br>
          <strong>layer_info.txt</strong> — Specifiche colori layer
        </p>
      </div>
      <div class="req-card">
        <span class="rc-tag">File layer_info.txt</span>
        <p>
          Indicare per ogni layer: nome esatto e colore.<br>
          <strong>Esempio:</strong><br>
          Layer demolizioni: DEMOL → Giallo #FFD700<br>
          Layer nuove opere: NUOVE → Rosso #FF0000<br>
          <em style="color:var(--dim)">Se assente, si applica il default.</em>
        </p>
      </div>
      <div class="req-card">
        <span class="rc-tag">Requisito Critico</span>
        <p>Le piante DWG <strong>devono essere perfettamente sovrapponibili</strong>: stesso sistema di riferimento, stessa origine geometrica, stessa scala assoluta. File non conformi verranno rigettati senza addebito.</p>
      </div>
      <div class="req-card">
        <span class="rc-tag">Formato Archivio</span>
        <p>Comprimi tutto in un unico file <strong>.ZIP</strong>. Non inviare cartelle o file sciolti. Formato DWG: AutoCAD 2013 o compatibile.</p>
      </div>
    </div>
    <div class="box-yellow">⚠ File DWG non sovrapponibili verranno rigettati. Verifica l'allineamento delle piante prima dell'invio. La commissione viene annullata senza addebito e puoi reinviare i file corretti entro 5 gg. lavorativi.</div>
  </div>
</div>

<!-- §06 MODULO DI RICHIESTA -->
<div class="sec" id="commissione">
  <div class="wrap">
    <h2>Modulo di Commissione</h2>
    <p style="font-size:0.88rem; color:var(--muted); margin-bottom:24px; line-height:1.8;">Compila tutti i campi obbligatori (<span style="color:var(--red)">*</span>), allega il file ZIP e spunta le dichiarazioni in fondo. Riceverai conferma immediata e parcella entro 48h.</p>

    <form id="commessa-form">
      <div class="form-grid">
        <div class="fg">
          <label for="nome">Nome <span class="req">*</span></label>
          <input type="text" id="nome" name="nome" required placeholder="Nome" autocomplete="given-name">
        </div>
        <div class="fg">
          <label for="cognome">Cognome <span class="req">*</span></label>
          <input type="text" id="cognome" name="cognome" required placeholder="Cognome" autocomplete="family-name">
        </div>
        <div class="fg">
          <label for="telefono">Telefono <span class="req">*</span></label>
          <input type="tel" id="telefono" name="telefono" required placeholder="Telefono" autocomplete="tel">
        </div>
        <div class="fg">
          <label for="email">Email <span class="req">*</span></label>
          <input type="email" id="email" name="email" required placeholder="Email" autocomplete="email">
        </div>
        <div class="fg full">
          <label for="cf-piva">Codice Fiscale / Partita IVA <span class="req">*</span></label>
          <input type="text" id="cf-piva" name="cf_piva" required placeholder="Codice Fiscale o Partita IVA" autocomplete="off">
        </div>
        <div class="fg full">
          <label for="indirizzo-fatt">Indirizzo di Fatturazione <span class="req">*</span></label>
          <input type="text" id="indirizzo-fatt" name="indirizzo_fatturazione" required placeholder="Indirizzo di fatturazione" autocomplete="street-address">
        </div>
        <div class="fg full">
          <label for="pec">PEC <span style="color:var(--muted);font-weight:300;">(opzionale — per ricevere fattura in formato elettronico)</span></label>
          <input type="email" id="pec" name="pec" placeholder="Indirizzo PEC">
        </div>
        <div class="fg full">
          <label for="note">Note e Specifiche</label>
          <textarea id="note" name="note" placeholder="Numero tavole, layer particolari, scadenze urgenti, richieste specifiche sui colori o sulle scale…"></textarea>
        </div>
        <div class="fg full">
          <label for="file-allegato">File ZIP <span class="req">*</span> — DWG stato di fatto + DWG progetto + layer_info.txt</label>
          <input type="file" id="file-allegato" name="attachment" accept=".zip" required />
          <div class="zip-error" id="zip-error">⚠ Il file selezionato non è un archivio .ZIP. Comprimi i tuoi file in un .zip e ricarica.</div>
          <div class="zip-box">
            <p>
              <span class="zy">▸ Struttura richiesta nel file ZIP:</span><br>
              — <span class="zt">stato_di_fatto.dwg</span> — Pianta Stato di Fatto<br>
              — <span class="zt">progetto.dwg</span> — Pianta Progetto (sovrapponibile al precedente)<br>
              — <span class="zt">layer_info.txt</span> — Specifiche colori layer <strong style="color:var(--red)">(fortemente consigliato)</strong><br><br>
              <span class="zy">▸ Esempio layer_info.txt:</span><br>
              Layer demolizioni: <span class="zt">DEMOL</span> → Colore: <span style="color:#FFD700">Giallo #FFD700</span><br>
              Layer nuove opere: <span class="zt">NUOVE</span> → Colore: <span style="color:#e07060">Rosso #FF0000</span><br><br>
              <span style="color:var(--dim)">Se .TXT assente: si applica Giallo = demolizioni / Rosso = nuove realizzazioni.</span>
            </p>
          </div>
        </div>
      </div>

      <div class="submit-area">
        <div class="box-red" style="margin-bottom:20px;">
          <div class="bx-tag">⚠ Avviso Importante — Lettura obbligatoria prima dell'invio</div>
          <p>Questo è un servizio di <strong>supporto grafico tecnico</strong> e <strong>NON costituisce consulenza professionale asseverata</strong> ai sensi della normativa vigente (D.P.R. 380/2001 e s.m.i.). Le tavole prodotte sono materiale di ausilio alla progettazione e non sostituiscono la verifica, la firma e l'asseverazione di un professionista abilitato. Il committente rimane il solo responsabile dell'utilizzo delle tavole nell'ambito di pratiche edilizie o di qualsiasi altra natura giuridica.</p>
        </div>
        <p style="font-size:0.8rem; color:var(--dim); font-family:var(--mono); margin-bottom:4px; letter-spacing:0.06em; text-transform:uppercase;">Dichiarazioni obbligatorie — spuntare tutte e tre per procedere</p>

        <div class="chk-row">
          <input type="checkbox" id="chk1" name="accetto-disclaimer" value="si" required>
          <label for="chk1">Ho letto il disclaimer e dichiaro di aver compreso che questo è un <strong>servizio di supporto grafico tecnico</strong> e <strong>non una consulenza professionale asseverata</strong>. Rimango il solo responsabile dell'utilizzo delle tavole prodotte nell'ambito di pratiche edilizie o di qualsiasi altra natura giuridica.</label>
        </div>

        <div class="chk-row">
          <input type="checkbox" id="chk2" name="file-sovrapponibili" value="si" required>
          <label for="chk2">Confermo che i file DWG allegati sono <strong>perfettamente sovrapponibili</strong> (Stato di Fatto vs Progetto), con la stessa scala e la stessa origine geometrica. Sono consapevole che file non sovrapponibili <strong>non verranno processati</strong> e la commessa sarà rigettata senza addebito.</label>
        </div>

        <div class="chk-row">
          <input type="checkbox" id="chk3" name="accetto-privacy" value="si" required>
          <label for="chk3">Acconsento al trattamento dei dati personali forniti ai fini della gestione della presente commissione, ai sensi del <strong>GDPR 2016/679</strong> e del D.Lgs. 196/2003.</label>
        </div>

        <div class="submit-row">
          <button type="submit" id="submit-btn">Invia Commissione →</button>
          <div class="submit-hint">
            Riceverai la parcella entro 48h lavorative via mail.<br>
            Consegna entro 24h lavorative dal pagamento ricevuto.
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- OVERLAY -->
<div id="form-overlay">
  <div id="ov-loading">
    <div class="ov-seal">Invio in Corso</div>
    <div class="ov-spinner"></div>
    <div class="ov-title">Invio commessa in corso…<br>Non chiudere questa pagina.</div>
    <div class="ov-progress-wrap"><div class="ov-progress-bar" id="ov-bar"></div></div>
    <div class="ov-subtitle" id="ov-loading-detail">Preparazione pacchetto documentale…</div>
  </div>
  <div id="ov-success" style="display:none;flex-direction:column;align-items:center;gap:24px;">
    <div class="ov-seal">Commissione Ricevuta</div>
    <div class="ov-check">✓</div>
    <div class="ov-title">Commessa acquisita correttamente.</div>
    <div class="ov-subtitle">Riceverai la parcella all'indirizzo e-mail indicato entro <strong style="color:#dde4f0">48 ore lavorative</strong>.</div>
    <div class="ov-date" id="ov-protocol">Ref.: —<br>Data: —</div>
  </div>
  <div id="ov-error" style="display:none;flex-direction:column;align-items:center;gap:20px;">
    <div class="ov-seal">Trasmissione Interrotta</div>
    <div class="ov-error-icon">✕</div>
    <div class="ov-title">Errore durante l'invio.</div>
    <div class="ov-subtitle" id="ov-error-detail">Verificare la connessione e riprovare.</div>
    <button class="ov-btn-back">← Torna al Modulo</button>
  </div>
</div>

<footer>
  <div class="ft">
    <div class="ft-info">
      <div class="ft-name">Geom. Pegoraro Alex</div>
      <p>Email: <a href="/cdn-cgi/l/email-protection#7a0a1f1d15081b08151b161f021d1f15173a1d171b131654191517"><span class="__cf_email__" data-cfemail="e79782808895869588868b829f8082888aa7808a868e8bc984888a">[email&#160;protected]</span></a></p>
      <p>PEC: <a href="/cdn-cgi/l/email-protection#99f8f5fce1b7e9fcfef6ebf8ebf6d9fefcf6e9fcfab7f0ed"><span class="__cf_email__" data-cfemail="86e7eae3fea8f6e3e1e9f4e7f4e9c6e1e3e9f6e3e5a8eff2">[email&#160;protected]</span></a></p>
      <p>P.IVA: 04505080244</p>
    </div>
    <div class="ft-right">
      <div>© 2025 Geom. Pegoraro Alex</div>
      <div>Tavole Sinottiche</div>
    </div>
  </div>
  <div class="ft-legal">
    Il presente sito non costituisce consulenza professionale asseverata. I servizi offerti sono di esclusivo supporto grafico tecnico alla progettazione. P.IVA 04505080244.
  </div>
</footer>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
<script>
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');

  const PALETTE = ["192,57,43","220,100,80","201,151,10","230,170,40"];

  let W, H, nodes, hubs, t = 0;

  function resize() {
    W = canvas.width = window.innerWidth;
    H = canvas.height = window.innerHeight;
    build();
  }

  function rand(a, b) { return a + Math.random() * (b - a); }
  function pick() { return PALETTE[Math.floor(Math.random() * PALETTE.length)]; }

  function build() {
    // 3 layers of nodes at different speeds (parallax depth)
    nodes = [];
    const layers = [
      { count: 18, speed: 0.12, rMin: 0.5, rMax: 1.2, alpha: 0.35 },
      { count: 28, speed: 0.26, rMin: 0.8, rMax: 2.0, alpha: 0.50 },
      { count: 14, speed: 0.48, rMin: 1.2, rMax: 3.2, alpha: 0.65 },
    ];
    for (const l of layers) {
      for (let i = 0; i < l.count; i++) {
        const baseR = rand(l.rMin, l.rMax);
        nodes.push({
          x: rand(0, W), y: rand(0, H),
          vx: (Math.random()-0.5)*l.speed,
          vy: (Math.random()-0.5)*l.speed,
          r: baseR,
          baseR,
          pulseSpeed: rand(0.008, 0.022),
          pulsePhase: rand(0, Math.PI*2),
          alpha: l.alpha,
          col: pick(),
          layer: l.speed,
          isHub: false,
        });
      }
    }

    // 4–5 "hub" nodes: larger, slower, with glow rings
    hubs = [];
    for (let i = 0; i < 5; i++) {
      hubs.push({
        x: rand(W*0.1, W*0.9),
        y: rand(H*0.1, H*0.9),
        vx: (Math.random()-0.5)*0.08,
        vy: (Math.random()-0.5)*0.08,
        r: rand(3.5, 6),
        ringPhase: rand(0, Math.PI*2),
        col: pick(),
      });
    }
  }

  function drawGradientLine(x1, y1, x2, y2, col1, col2, alpha) {
    const grad = ctx.createLinearGradient(x1, y1, x2, y2);
    grad.addColorStop(0, 'rgba(' + col1 + ',' + alpha + ')');
    grad.addColorStop(1, 'rgba(' + col2 + ',' + alpha + ')');
    ctx.beginPath();
    ctx.strokeStyle = grad;
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();
  }

  function draw() {
    ctx.clearRect(0, 0, W, H);

    // Dark vignette over top-left title area to keep text readable
    const vx = W * 0.0, vy = H * 0.0;
    const vg = ctx.createRadialGradient(W*0.28, H*0.38, 0, W*0.28, H*0.38, W*0.45);
    vg.addColorStop(0,   'rgba(15,17,23,0.82)');
    vg.addColorStop(0.5, 'rgba(15,17,23,0.45)');
    vg.addColorStop(1,   'rgba(15,17,23,0)');
    ctx.fillStyle = vg;
    ctx.fillRect(0, 0, W, H);
    t += 0.012;

    // --- Draw connections between regular nodes ---
    const MAX_DIST = 150;
    for (let i = 0; i < nodes.length; i++) {
      for (let j = i+1; j < nodes.length; j++) {
        if (Math.abs(nodes[i].layer - nodes[j].layer) > 0.01) continue; // only same layer
        const dx = nodes[i].x - nodes[j].x, dy = nodes[i].y - nodes[j].y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < MAX_DIST) {
          const a = (1 - dist/MAX_DIST) * nodes[i].alpha * 0.6;
          ctx.lineWidth = 0.7;
          drawGradientLine(nodes[i].x, nodes[i].y, nodes[j].x, nodes[j].y, nodes[i].col, nodes[j].col, a);
        }
      }
    }

    // --- Draw connections from hubs to nearby nodes ---
    const HUB_DIST = 220;
    for (const h of hubs) {
      for (const n of nodes) {
        const dx = h.x - n.x, dy = h.y - n.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < HUB_DIST) {
          const a = (1 - dist/HUB_DIST) * 0.28;
          ctx.lineWidth = 0.6;
          drawGradientLine(h.x, h.y, n.x, n.y, h.col, n.col, a);
        }
      }
    }

    // --- Draw regular nodes ---
    for (const n of nodes) {
      // Pulse radius
      n.r = n.baseR + Math.sin(t * n.pulseSpeed / 0.012 + n.pulsePhase) * n.baseR * 0.35;

      ctx.beginPath();
      ctx.arc(n.x, n.y, n.r, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(' + n.col + ',' + n.alpha + ')';
      ctx.fill();

      // Soft glow on larger nodes
      if (n.baseR > 1.8) {
        ctx.beginPath();
        ctx.arc(n.x, n.y, n.r * 2.5, 0, Math.PI*2);
        const glow = ctx.createRadialGradient(n.x, n.y, n.r*0.5, n.x, n.y, n.r*2.5);
        glow.addColorStop(0, 'rgba(' + n.col + ',' + (n.alpha*0.3) + ')');
        glow.addColorStop(1, 'rgba(' + n.col + ',0)');
        ctx.fillStyle = glow;
        ctx.fill();
      }

      n.x += n.vx; n.y += n.vy;
      if (n.x < 0 || n.x > W) n.vx *= -1;
      if (n.y < 0 || n.y > H) n.vy *= -1;
    }

    // --- Draw hubs ---
    for (const h of hubs) {
      h.ringPhase += 0.008;

      // Outer expanding ring
      const ringR = h.r + 6 + Math.sin(h.ringPhase) * 4;
      const ringAlpha = 0.08 + Math.sin(h.ringPhase) * 0.05;
      ctx.beginPath();
      ctx.arc(h.x, h.y, ringR, 0, Math.PI*2);
      ctx.strokeStyle = 'rgba(' + h.col + ',' + ringAlpha + ')';
      ctx.lineWidth = 1.2;
      ctx.stroke();

      // Second ring
      const ring2R = h.r + 14 + Math.sin(h.ringPhase + 1) * 6;
      ctx.beginPath();
      ctx.arc(h.x, h.y, ring2R, 0, Math.PI*2);
      ctx.strokeStyle = 'rgba(' + h.col + ',' + (ringAlpha * 0.5) + ')';
      ctx.lineWidth = 0.7;
      ctx.stroke();

      // Core glow
      const grad = ctx.createRadialGradient(h.x, h.y, 0, h.x, h.y, h.r*4);
      grad.addColorStop(0, 'rgba(' + h.col + ',0.55)');
      grad.addColorStop(0.4, 'rgba(' + h.col + ',0.15)');
      grad.addColorStop(1, 'rgba(' + h.col + ',0)');
      ctx.beginPath();
      ctx.arc(h.x, h.y, h.r*4, 0, Math.PI*2);
      ctx.fillStyle = grad;
      ctx.fill();

      // Core dot
      ctx.beginPath();
      ctx.arc(h.x, h.y, h.r, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(' + h.col + ',0.75)';
      ctx.fill();

      h.x += h.vx; h.y += h.vy;
      if (h.x < 0 || h.x > W) h.vx *= -1;
      if (h.y < 0 || h.y > H) h.vy *= -1;
    }

    requestAnimationFrame(draw);
  }

  window.addEventListener('resize', resize);
  resize(); draw();
</script>

<script>
(function(){
  var PREZZI = { std: 55, cplx: 75, rev: 30 };
  var LABELS = {
    std:  'Tavola Sinottica Standard',
    cplx: 'Tavola Sinottica Complessa',
    rev:  'Revisione Post-Consegna'
  };
  var BOLLO = 2.00;
  var CIPAG = 0.05;
  window.pacchettoAttivo = null;
  window.preventivoConfermato = false;

  function fmt(n) {
    return n.toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2, useGrouping:true}) + ' €';
  }
  function g(id) { return document.getElementById(id); }

  window.selezionaPacchetto = function(id) {
    document.querySelectorAll('.pkg-sel-card').forEach(function(c){ c.classList.remove('selected'); });
    g('card-' + id).classList.add('selected');
    window.pacchettoAttivo = id;
    // Se si cambia pacchetto dopo aver confermato, resetta la conferma
    if (window.preventivoConfermato) {
      window.preventivoConfermato = false;
          var btn = g('calc-cta-btn');
      btn.classList.remove('confermato');
      btn.textContent = 'Aggiungi a Commessa →';
    }
    aggiornaPreventivo();
  };

  function aggiornaPreventivo() {
    if (!window.pacchettoAttivo) return;
    var prezzoBase = PREZZI[window.pacchettoAttivo];
    var cipagImporto = (prezzoBase + BOLLO) * CIPAG;
    var totale = prezzoBase + BOLLO + cipagImporto;

    g('prev-righe').innerHTML =
      '<div class="prev-riga"><span>' + LABELS[window.pacchettoAttivo] + '</span><span>' + fmt(prezzoBase) + '</span></div>' +
      '<div class="prev-riga"><span>Imposta di bollo (art. 13 DPR 642/72)</span><span>' + fmt(BOLLO) + '</span></div>' +
      '<div class="prev-riga"><span>Contributo integrativo CIPAG (5%)</span><span>' + fmt(cipagImporto) + '</span></div>';

    g('prev-totale').textContent = fmt(totale);
    g('pacchetto-selezionato').value = LABELS[window.pacchettoAttivo];
    g('preventivo-totale-hidden').value = fmt(totale);
    g('preventivo-dettaglio-hidden').value =
      LABELS[window.pacchettoAttivo] + ' ' + fmt(prezzoBase) + ' | Bollo ' + fmt(BOLLO) + ' | CIPAG 5% ' + fmt(cipagImporto) + ' | TOTALE ' + fmt(totale);
    g('preventivo-box').style.display = 'block';
    g('calc-cta-btn').style.display = 'block';
    g('prev-warning').style.display = 'none';
  }

  window.usaPreventivo = function() {
    if (!window.pacchettoAttivo) return;
    var btn = g('calc-cta-btn');
    window.preventivoConfermato = true;
    btn.classList.add('confermato');
    btn.textContent = '✓ Preventivo Aggiunto alla Commessa';
    g('prev-warning').style.display = 'none';
    document.getElementById('commissione').scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  document.addEventListener('DOMContentLoaded', function() {
    g('card-std').addEventListener('click',   function() { window.selezionaPacchetto('std'); });
    g('card-std').addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') window.selezionaPacchetto('std'); });
    g('card-cplx').addEventListener('click',  function() { window.selezionaPacchetto('cplx'); });
    g('card-cplx').addEventListener('keydown',function(e){ if(e.key==='Enter'||e.key===' ') window.selezionaPacchetto('cplx'); });
    g('card-rev').addEventListener('click',   function() { window.selezionaPacchetto('rev'); });
    g('card-rev').addEventListener('keydown', function(e){ if(e.key==='Enter'||e.key===' ') window.selezionaPacchetto('rev'); });
    g('calc-cta-btn').addEventListener('click', window.usaPreventivo);
    g('form-overlay').querySelector('.ov-btn-back').addEventListener('click', window.closeOverlay);
  });

})();
</script>

<script>
  var GAS_ENDPOINT = 'https://script.google.com/macros/s/AKfycbzyT_DossdKQQmnAZ57vBknnUuq6JDx5-5GsesO_FkN5GtYc_DrQHCXheApeS67jyuj/exec';

  function fileToBase64(file) {
    return new Promise(function(resolve, reject) {
      var reader = new FileReader();
      reader.onload  = function() { resolve(reader.result.split(',')[1]); };
      reader.onerror = function() { reject(new Error('Lettura file fallita')); };
      reader.readAsDataURL(file);
    });
  }

  window.showOverlay = function(state) {
    var overlay = document.getElementById('form-overlay');
    overlay.classList.add('active');
    document.getElementById('ov-loading').style.display = (state === 'loading') ? 'flex' : 'none';
    document.getElementById('ov-success').style.display = (state === 'success') ? 'flex' : 'none';
    document.getElementById('ov-error').style.display   = (state === 'error')   ? 'flex' : 'none';
  };

  window.closeOverlay = function() {
    document.getElementById('form-overlay').classList.remove('active');
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('ov-bar').style.width = '0%';
    document.getElementById('ov-loading-detail').textContent = 'Preparazione pacchetto documentale…';
  };

  function setProgress(pct, label) {
    document.getElementById('ov-bar').style.width = pct + '%';
    if (label) document.getElementById('ov-loading-detail').textContent = label;
  }

  document.getElementById('file-allegato').addEventListener('change', function() {
    const zipErr = document.getElementById('zip-error');
    if (this.files && this.files[0]) {
      const fname = this.files[0].name.toLowerCase();
      zipErr.style.display = fname.endsWith('.zip') ? 'none' : 'block';
      if (!fname.endsWith('.zip')) this.value = '';
    }
  });

  document.getElementById('commessa-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form   = e.target;
    const btn    = document.getElementById('submit-btn');
    const fileEl = document.getElementById('file-allegato');

    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }

    // BLOCCO: preventivo deve essere confermato con "Aggiungi a Commessa"
    if (!window.preventivoConfermato) {
      document.getElementById('prev-warning').style.display = 'block';
      document.getElementById('calc-cta-btn').style.display = 'block';
      document.getElementById('calcolatore').scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }

    // Controllo estensione ZIP
    const fileElCheck = document.getElementById('file-allegato');
    const zipErr = document.getElementById('zip-error');
    if (fileElCheck && fileElCheck.files && fileElCheck.files[0]) {
      const fname = fileElCheck.files[0].name.toLowerCase();
      if (!fname.endsWith('.zip')) {
        zipErr.style.display = 'block';
        fileElCheck.value = '';
        return;
      } else { zipErr.style.display = 'none'; }
    }

    btn.disabled = true;
    showOverlay('loading');
    setProgress(5, 'Lettura documentale in corso…');

    // 1. Leggi il file come Base64
    let attachmentBase64 = null;
    let attachmentName   = null;
    let attachmentSize   = null;

    if (fileEl.files && fileEl.files[0]) {
      const file = fileEl.files[0];
      attachmentName = file.name;
      attachmentSize = file.size;
      try {
        setProgress(20, 'Codifica pacchetto dati…');
        attachmentBase64 = await fileToBase64(file);
        setProgress(55, 'File allegato elaborato correttamente…');
      } catch (err) {
        document.getElementById('ov-error-detail').textContent =
          'Impossibile leggere il file allegato. Verificare che il file non sia corrotto e riprovare.';
        showOverlay('error');
        return;
      }
    }

    // 2. Costruisci il payload JSON
    const payload = {
      nome:                   document.getElementById('nome').value.trim(),
      cognome:                document.getElementById('cognome').value.trim(),
      telefono:               document.getElementById('telefono').value.trim(),
      email:                  document.getElementById('email').value.trim(),
      pec:                    document.getElementById('pec').value.trim(),
      cf_piva:                document.getElementById('cf-piva').value.trim(),
      indirizzo_fatturazione: document.getElementById('indirizzo-fatt').value.trim(),
      note:                   document.getElementById('note').value.trim(),
      servizio:               'Tavole Sinottiche',
      pacchetto:              document.getElementById('pacchetto-selezionato').value,
      preventivo_totale:      document.getElementById('preventivo-totale-hidden').value,
      preventivo_dettaglio:   document.getElementById('preventivo-dettaglio-hidden').value,
      attachment: {
        name:   attachmentName,
        size:   attachmentSize,
        base64: attachmentBase64
      },
      timestamp: new Date().toISOString()
    };

    setProgress(70, 'Invio dati al server in corso…');

    // 3. Invia al Google Apps Script
    try {
      const response = await fetch(GAS_ENDPOINT, {
        method:   'POST',
        redirect: 'follow',
        body:     JSON.stringify(payload)
      });

      setProgress(95, 'Verifica risposta…');

      if (!response.ok && response.type !== 'opaque') {
        throw new Error(`Risposta server: ${response.status} ${response.statusText}`);
      }

      setProgress(100, 'Archiviazione completata.');
      await new Promise(r => setTimeout(r, 600));

      const ref  = 'PEG-' + Date.now().toString(36).toUpperCase();
      const data = new Date().toLocaleString('it-IT', {
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
      document.getElementById('ov-protocol').innerHTML =
        `Ref.: <strong>${ref}</strong><br>Data: ${data}`;

      showOverlay('success');

    } catch (err) {
      document.getElementById('ov-error-detail').textContent =
        'Errore di rete. Verificare la connessione e riprovare. Dettaglio: ' + err.message;
      showOverlay('error');
    }
  });
</script>

</body>
</html>
